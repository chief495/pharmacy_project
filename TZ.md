# Техническое задание: PharmaMonitor

## 1. Идея проекта

PharmaMonitor — это веб-система для мониторинга наличия лекарственных препаратов в аптечных сетях. Проект предназначен для помощи пользователям в поиске нужных препаратов, сравнении цен и получении уведомлений о появлении препаратов в наличии.

## 2. Цель проекта

Создать удобную платформу, которая позволит пользователям:
- Быстро находить информацию о наличии препаратов
- Сравнивать цены в разных аптеках
- Получать автоматические уведомления о появлении препаратов
- Находить аналоги препаратов

## 3. Роли пользователей

### 3.1. Обычный пользователь (неавторизованный)
- Просмотр списка препаратов
- Поиск препаратов по названию, МНН или производителю
- Просмотр детальной информации о препарате
- Просмотр наличия и цен в аптеках
- Регистрация и вход в систему

### 3.2. Авторизованный пользователь
- Все функции обычного пользователя
- Создание подписок на препараты
- Управление своими подписками (редактирование, удаление)
- Получение email-уведомлений о наличии препаратов
- Настройка параметров подписки (город, максимальная цена)

### 3.3. Администратор
- Все функции авторизованного пользователя
- Полный доступ к административной панели Django
- Управление препаратами, аптеками, сетями
- Управление пользователями
- Просмотр статистики и отчетов
- Управление подписками пользователей

## 4. Схема данных

### 4.1. CustomUser (Кастомная модель пользователя)
**Назначение**: Пользователи системы с аутентификацией по email

**Поля**:
- `email` (EmailField, unique=True) - электронная почта (используется как USERNAME_FIELD)
- `first_name` (CharField, max_length=150) - имя
- `last_name` (CharField, max_length=150) - фамилия
- `is_staff` (BooleanField) - является ли сотрудником
- `is_active` (BooleanField) - активен ли аккаунт
- `date_joined` (DateTimeField, auto_now_add=True) - дата регистрации
- `email_notifications` (BooleanField) - разрешены ли email-уведомления
- Наследует от AbstractBaseUser и PermissionsMixin

**Связи**: Один-ко-многим с UserSubscription

### 4.2. Drug (Препарат)
**Назначение**: Информация о лекарственных препаратах

**Поля**:
- `mnn` (CharField, max_length=255) - МНН (Международное непатентованное название)
- `trade_name` (CharField, max_length=255) - торговое название
- `form` (CharField, max_length=100) - форма выпуска (таблетки, капсулы и т.д.)
- `dosage` (CharField, max_length=100) - дозировка
- `manufacturer` (CharField, max_length=255) - производитель
- `atx_code` (CharField, max_length=20, nullable) - АТХ код
- `description` (TextField, nullable) - описание препарата
- `created_at` (DateTimeField, auto_now_add=True) - дата добавления
- `updated_at` (DateTimeField, auto_now=True) - дата обновления

**Связи**: 
- Один-ко-многим с Availability
- Один-ко-многим с UserSubscription
- Многие-ко-многим с Analogue (оригинал и аналог)

**Методы**: `__str__()` - возвращает строку вида "Название (МНН)"

### 4.3. PharmacyNetwork (Аптечная сеть)
**Назначение**: Сети аптек (36.6, ЕАптека и т.д.)

**Поля**:
- `name` (CharField, max_length=100) - название сети
- `website` (URLField, nullable) - сайт сети
- `phone` (CharField, max_length=20, nullable) - телефон
- `is_active` (BooleanField, default=True) - активна ли сеть

**Связи**: Один-ко-многим с Pharmacy

**Методы**: `__str__()` - возвращает название сети

### 4.4. Pharmacy (Аптека)
**Назначение**: Конкретные аптеки

**Поля**:
- `network` (ForeignKey -> PharmacyNetwork) - сеть аптек
- `name` (CharField, max_length=100) - название аптеки
- `address` (TextField) - адрес
- `city` (CharField, max_length=100) - город
- `phone` (CharField, max_length=20, nullable) - телефон
- `latitude` (FloatField, nullable) - широта (для карт)
- `longitude` (FloatField, nullable) - долгота (для карт)
- `working_hours` (CharField, max_length=100, nullable) - часы работы

**Связи**: 
- Многие-к-одному с PharmacyNetwork
- Один-ко-многим с Availability

**Методы**: `__str__()` - возвращает строку вида "Название (Адрес)"

### 4.5. Availability (Наличие препарата)
**Назначение**: Наличие препарата в конкретной аптеке с ценой

**Поля**:
- `drug` (ForeignKey -> Drug) - препарат
- `pharmacy` (ForeignKey -> Pharmacy) - аптека
- `price` (DecimalField, max_digits=10, decimal_places=2) - цена
- `quantity` (IntegerField, default=0) - количество в наличии
- `last_updated` (DateTimeField, auto_now=True) - последнее обновление
- `is_available` (BooleanField, default=True) - в наличии

**Связи**: 
- Многие-к-одному с Drug
- Многие-к-одному с Pharmacy
- Один-ко-многим с PriceHistory

**Ограничения**: `unique_together = ['drug', 'pharmacy']` - один препарат в одной аптеке

**Методы**: `__str__()` - возвращает строку с названием препарата, аптеки и ценой

### 4.6. UserSubscription (Подписка пользователя)
**Назначение**: Подписки пользователей на уведомления о препаратах

**Поля**:
- `user` (ForeignKey -> CustomUser) - пользователь
- `drug` (ForeignKey -> Drug) - препарат
- `city` (CharField, max_length=100, nullable) - город для фильтрации
- `max_price` (DecimalField, max_digits=10, decimal_places=2, nullable) - максимальная цена
- `is_active` (BooleanField, default=True) - активна ли подписка
- `created_at` (DateTimeField, auto_now_add=True) - дата создания

**Связи**: 
- Многие-к-одному с CustomUser
- Многие-к-одному с Drug

**Ограничения**: `unique_together = ['user', 'drug', 'city']` - уникальность подписки

**Методы**: `__str__()` - возвращает информацию о подписке

### 4.7. Analogue (Аналог препарата)
**Назначение**: Связь между препаратами-аналогами

**Поля**:
- `original` (ForeignKey -> Drug, related_name='original_drug') - оригинальный препарат
- `analogue` (ForeignKey -> Drug, related_name='analogue_drug') - аналог
- `similarity_score` (FloatField, default=0.0) - коэффициент схожести (0-1)
- `is_active` (BooleanField, default=True) - активна ли связь
- `created_at` (DateTimeField, auto_now_add=True) - дата создания

**Ограничения**: `unique_together = ['original', 'analogue']` - уникальность связи

**Методы**: `__str__()` - возвращает строку вида "Оригинал → Аналог"

### 4.8. PriceHistory (История цен)
**Назначение**: История изменения цен на препараты в аптеках

**Поля**:
- `availability` (ForeignKey -> Availability) - наличие препарата
- `price` (DecimalField, max_digits=10, decimal_places=2) - цена
- `recorded_at` (DateTimeField, auto_now_add=True) - дата записи

**Связи**: Многие-к-одному с Availability

**Сортировка**: По умолчанию `ordering = ['-recorded_at']` (новые первыми)

**Методы**: `__str__()` - возвращает строку с названием препарата, ценой и датой

## 5. Основные сценарии использования

### 5.1. Регистрация и вход
1. Пользователь заходит на главную страницу
2. Нажимает "Регистрация"
3. Заполняет форму (email, имя, фамилия, пароль)
4. После успешной регистрации автоматически входит в систему
5. При следующем визите использует "Вход" с email и паролем

### 5.2. Поиск препарата
1. Пользователь вводит название препарата в поисковую строку
2. Система отображает список найденных препаратов
3. Пользователь выбирает нужный препарат
4. Система показывает детальную информацию, наличие в аптеках и цены

### 5.3. Подписка на препарат
1. Авторизованный пользователь открывает страницу препарата
2. Нажимает "Подписаться на уведомления"
3. Заполняет форму подписки (можно указать город и максимальную цену)
4. Система создает подписку
5. При появлении препарата в наличии система отправляет email-уведомление

### 5.4. Получение уведомления
1. Препарат появляется в наличии в аптеках, соответствующих критериям подписки
2. Система запускает команду отправки уведомлений (через cron или management command)
3. Проверяются все активные подписки
4. Для каждой подписки проверяется наличие препарата
5. Отправляется email с информацией о наличии и ценах

### 5.5. Управление подписками
1. Пользователь заходит в "Мои подписки"
2. Видит список всех своих подписок
3. Может редактировать подписку (город, максимальная цена, активность)
4. Может отписаться от уведомлений

### 5.6. Просмотр аналогов
1. Пользователь открывает страницу препарата
2. В разделе "Аналоги" видит список похожих препаратов
3. Может перейти на страницу аналога
4. Сравнивает цены и наличие

## 6. Технические требования

### 6.1. Backend
- Django 4.2+
- Python 3.8+
- Кастомная модель пользователя с email-аутентификацией
- Django ORM для работы с БД
- Django Forms для валидации
- Email backend для отправки уведомлений

### 6.2. Frontend
- Bootstrap 5 для стилизации
- Responsive дизайн (адаптивность для мобильных устройств)
- Наследование шаблонов Django
- Bootstrap Icons для иконок

### 6.3. База данных
- SQLite для разработки
- PostgreSQL для production (рекомендуется)
- Миграции Django для управления схемой БД

### 6.4. Безопасность
- Хранение секретных ключей в переменных окружения
- CSRF защита
- Хеширование паролей
- Валидация данных на сервере

## 7. Критерии оценки проекта

Проект должен соответствовать следующим требованиям:

1. **Планирование и культура разработки (20 баллов)**
   - Наличие TZ.md с описанием проекта
   - Наличие .gitignore и requirements.txt
   - Чистота репозитория (нет venv, __pycache__, db.sqlite3)
   - Регулярные коммиты с осмысленными названиями
   - Полный README.md с описанием и инструкциями

2. **Работа с данными (20 баллов)**
   - Не менее 3 кастомных моделей (CustomUser, Drug, и другие)
   - Правильное использование связей (ForeignKey, ManyToManyField)
   - Использование фильтрации, сортировки, агрегации (Count, Sum, Avg)
   - Наполненная БД (10-15 записей)

3. **Техническая сложность (20 баллов)**
   - Соблюдение PEP8
   - Отсутствие дублирования кода (DRY)
   - Использование внешнего API или библиотек анализа данных

4. **Интерфейс и формы (20 баллов)**
   - Django Forms / ModelForms с валидацией
   - Наследование шаблонов
   - Аккуратный интерфейс (Bootstrap)
   - Адаптивность

5. **Управление и Deploy (20 баллов)**
   - Регистрация всех моделей в admin.py
   - Настройки list_display и search_fields
   - Проект задеплоен на PythonAnywhere
   - DEBUG=False, статические файлы работают

## 8. Дальнейшее развитие

Возможные улучшения проекта:
- Интеграция с API фармацевтических баз данных
- Добавление карт с расположением аптек
- Расширенная аналитика цен
- Экспорт данных в Excel/PDF
- REST API для мобильных приложений
- Автоматическое обновление данных через парсинг сайтов аптек
- Личный кабинет с историей поисков
- Система отзывов о препаратах
